<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Diagnose Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #202124;
            color: #e8eaed;
            margin: 0;
            padding: 2rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #303134;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .section h2 {
            margin-bottom: 1rem;
            color: #8ab4f8;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        .test-card {
            background: #3c4043;
            border-radius: 6px;
            padding: 1rem;
        }
        .status {
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .status.success { background: #34a853; }
        .status.warning { background: #fbbc04; color: #000; }
        .status.error { background: #ea4335; }
        .status.info { background: #1a73e8; }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
        }
        button:hover { background: #1557b0; }
        .log {
            background: #1a1a1a;
            border-radius: 4px;
            padding: 1rem;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #5f6368;
        }
        .grid-demo {
            display: grid;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .demo-participant {
            aspect-ratio: 16/9;
            background: linear-gradient(135deg, #1a73e8, #34a853);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Meeting Diagnose Tool</h1>
        <p>Tool zur Diagnose und zum Testen der Meeting-Funktionalit√§t</p>

        <!-- System Status -->
        <div class="section">
            <h2>System Status</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Browser Compatibility</h3>
                    <div id="browserStatus"></div>
                    <button onclick="testBrowserSupport()">Test Browser</button>
                </div>
                
                <div class="test-card">
                    <h3>Media Devices</h3>
                    <div id="mediaStatus"></div>
                    <button onclick="testMediaDevices()">Test Media</button>
                </div>
                
                <div class="test-card">
                    <h3>Network Connection</h3>
                    <div id="networkStatus"></div>
                    <button onclick="testNetworkConnection()">Test Network</button>
                </div>
            </div>
        </div>

        <!-- LiveKit Status -->
        <div class="section">
            <h2>LiveKit SDK Status</h2>
            <div id="livekitStatus"></div>
            <button onclick="testLiveKitSDK()">Test LiveKit</button>
            <button onclick="simulateConnection()">Simulate Connection</button>
        </div>

        <!-- Grid Layout Demo -->
        <div class="section">
            <h2>Grid Layout Demo</h2>
            <p>Test verschiedene Teilnehmeranzahlen:</p>
            <div>
                <button onclick="showGridDemo(1)">1 Teilnehmer</button>
                <button onclick="showGridDemo(2)">2 Teilnehmer</button>
                <button onclick="showGridDemo(3)">3 Teilnehmer</button>
                <button onclick="showGridDemo(4)">4 Teilnehmer</button>
                <button onclick="showGridDemo(6)">6 Teilnehmer</button>
                <button onclick="showGridDemo(9)">9 Teilnehmer</button>
            </div>
            <div id="gridDemo" class="grid-demo"></div>
        </div>

        <!-- Connection Simulation -->
        <div class="section">
            <h2>Connection Tests</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Reconnection Test</h3>
                    <div id="reconnectionStatus"></div>
                    <button onclick="simulateDisconnect()">Simulate Disconnect</button>
                </div>
                
                <div class="test-card">
                    <h3>Track Attachment Test</h3>
                    <div id="trackStatus"></div>
                    <button onclick="simulateTrackIssues()">Simulate Track Issues</button>
                </div>
            </div>
        </div>

        <!-- Real-time Logs -->
        <div class="section">
            <h2>Real-time Logs</h2>
            <button onclick="clearLogs()">Clear Logs</button>
            <button onclick="enableDetailedLogging()">Enable Detailed Logging</button>
            <div id="logOutput" class="log">Logs werden hier angezeigt...\n</div>
        </div>

        <!-- Meeting Test -->
        <div class="section">
            <h2>Live Meeting Test</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Create Test Meeting</h3>
                    <button onclick="createTestMeeting()">Create Meeting</button>
                    <div id="meetingInfo"></div>
                </div>
                
                <div class="test-card">
                    <h3>Multi-User Simulation</h3>
                    <button onclick="openMultipleWindows()">Open Multiple Windows</button>
                    <p><small>√ñffnet mehrere Fenster zum Testen von Multi-User-Szenarien</small></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let logOutput = document.getElementById('logOutput');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logOutput.textContent += logEntry;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`${type}: ${message}`);
        }
        
        function clearLogs() {
            logOutput.textContent = '';
        }
        
        function enableDetailedLogging() {
            // Override console methods to capture all logs
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.log = function(...args) {
                log(args.join(' '), 'info');
                originalLog.apply(console, args);
            };
            
            console.error = function(...args) {
                log(args.join(' '), 'error');
                originalError.apply(console, args);
            };
            
            console.warn = function(...args) {
                log(args.join(' '), 'warning');
                originalWarn.apply(console, args);
            };
            
            log('Detailed logging enabled', 'info');
        }
        
        function testBrowserSupport() {
            const status = document.getElementById('browserStatus');
            const checks = [];
            
            // WebRTC Support
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                checks.push('<div class="status success">‚úÖ WebRTC unterst√ºtzt</div>');
            } else {
                checks.push('<div class="status error">‚ùå WebRTC nicht unterst√ºtzt</div>');
            }
            
            // Modern JS Features
            try {
                eval('const test = () => {}; class Test {}');
                checks.push('<div class="status success">‚úÖ Modern JavaScript unterst√ºtzt</div>');
            } catch (e) {
                checks.push('<div class="status error">‚ùå Veralteter Browser</div>');
            }
            
            // Grid Support
            if (CSS.supports('display', 'grid')) {
                checks.push('<div class="status success">‚úÖ CSS Grid unterst√ºtzt</div>');
            } else {
                checks.push('<div class="status warning">‚ö†Ô∏è CSS Grid nicht unterst√ºtzt</div>');
            }
            
            status.innerHTML = checks.join('');
            log('Browser support test completed', 'info');
        }
        
        async function testMediaDevices() {
            const status = document.getElementById('mediaStatus');
            status.innerHTML = '<div class="status info">üîÑ Testing...</div>';
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                const audioDevices = devices.filter(d => d.kind === 'audioinput');
                
                const results = [
                    `<div class="status success">‚úÖ ${videoDevices.length} Kamera(s) gefunden</div>`,
                    `<div class="status success">‚úÖ ${audioDevices.length} Mikrofon(e) gefunden</div>`
                ];
                
                // Test actual access
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    results.push('<div class="status success">‚úÖ Media access granted</div>');
                    stream.getTracks().forEach(track => track.stop());
                } catch (permissionError) {
                    results.push('<div class="status error">‚ùå Media access denied</div>');
                }
                
                status.innerHTML = results.join('');
                log('Media devices test completed', 'info');
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                log(`Media test error: ${error.message}`, 'error');
            }
        }
        
        async function testNetworkConnection() {
            const status = document.getElementById('networkStatus');
            status.innerHTML = '<div class="status info">üîÑ Testing...</div>';
            
            const tests = [];
            
            // Online status
            tests.push(navigator.onLine ? 
                '<div class="status success">‚úÖ Browser is online</div>' : 
                '<div class="status error">‚ùå Browser is offline</div>'
            );
            
            // Connection type
            if (navigator.connection) {
                const conn = navigator.connection;
                tests.push(`<div class="status info">üì∂ Connection: ${conn.effectiveType || 'unknown'}</div>`);
            }
            
            // Test server connectivity
            try {
                const response = await fetch('/health', { method: 'GET' });
                if (response.ok) {
                    tests.push('<div class="status success">‚úÖ Server reachable</div>');
                } else {
                    tests.push('<div class="status warning">‚ö†Ô∏è Server responded with error</div>');
                }
            } catch (error) {
                tests.push('<div class="status error">‚ùå Server unreachable</div>');
            }
            
            status.innerHTML = tests.join('');
            log('Network connection test completed', 'info');
        }
        
        function testLiveKitSDK() {
            const status = document.getElementById('livekitStatus');
            
            // Check if LiveKit is loaded
            const LiveKit = window.LiveKit || window.LivekitClient;
            
            if (LiveKit) {
                const version = LiveKit.version || 'Unknown';
                const components = Object.keys(LiveKit).length;
                status.innerHTML = `
                    <div class="status success">‚úÖ LiveKit SDK loaded</div>
                    <div class="status info">üìã Version: ${version}</div>
                    <div class="status info">üß© Components: ${components}</div>
                `;
                log(`LiveKit SDK loaded successfully. Version: ${version}`, 'info');
            } else {
                status.innerHTML = '<div class="status error">‚ùå LiveKit SDK not loaded</div>';
                log('LiveKit SDK not found', 'error');
            }
        }
        
        function showGridDemo(count) {
            const demo = document.getElementById('gridDemo');
            
            // Generate grid CSS based on count
            let gridCols;
            switch (count) {
                case 1: gridCols = '1fr'; break;
                case 2: gridCols = 'repeat(2, 1fr)'; break;
                case 3:
                case 4: gridCols = 'repeat(2, 1fr)'; break;
                case 5:
                case 6: gridCols = 'repeat(3, 1fr)'; break;
                default: gridCols = 'repeat(auto-fit, minmax(200px, 1fr))';
            }
            
            demo.style.gridTemplateColumns = gridCols;
            
            // Generate participants
            let html = '';
            for (let i = 1; i <= count; i++) {
                html += `<div class="demo-participant">User ${i}</div>`;
            }
            
            demo.innerHTML = html;
            log(`Grid demo: ${count} participants, columns: ${gridCols}`, 'info');
        }
        
        function simulateConnection() {
            log('Simulating LiveKit connection...', 'info');
            
            setTimeout(() => {
                log('‚úÖ Simulated connection successful', 'info');
            }, 1000);
            
            setTimeout(() => {
                log('üìπ Simulated video track attached', 'info');
            }, 1500);
            
            setTimeout(() => {
                log('üé§ Simulated audio track attached', 'info');
            }, 2000);
        }
        
        function simulateDisconnect() {
            const status = document.getElementById('reconnectionStatus');
            status.innerHTML = '<div class="status warning">üîÑ Simulating disconnect...</div>';
            
            log('Simulating network disconnect...', 'warning');
            
            setTimeout(() => {
                status.innerHTML = '<div class="status info">üîÑ Attempting reconnection...</div>';
                log('Attempting automatic reconnection...', 'info');
            }, 2000);
            
            setTimeout(() => {
                status.innerHTML = '<div class="status success">‚úÖ Reconnection successful</div>';
                log('‚úÖ Reconnection completed successfully', 'info');
            }, 4000);
        }
        
        function simulateTrackIssues() {
            const status = document.getElementById('trackStatus');
            log('Simulating track attachment issues...', 'warning');
            
            status.innerHTML = '<div class="status warning">‚ö†Ô∏è Track attachment failed</div>';
            
            setTimeout(() => {
                status.innerHTML = '<div class="status info">üîÑ Retrying with fallback method...</div>';
                log('Trying alternative track attachment method...', 'info');
            }, 2000);
            
            setTimeout(() => {
                status.innerHTML = '<div class="status success">‚úÖ Track attached successfully</div>';
                log('‚úÖ Track attachment successful with fallback', 'info');
            }, 4000);
        }
        
        async function createTestMeeting() {
            const info = document.getElementById('meetingInfo');
            info.innerHTML = '<div class="status info">üîÑ Creating test meeting...</div>';
            
            try {
                const response = await fetch('/api/meetings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ host_name: 'Test Host' })
                });
                
                if (response.ok) {
                    const meeting = await response.json();
                    info.innerHTML = `
                        <div class="status success">‚úÖ Meeting created</div>
                        <p><strong>Meeting ID:</strong> ${meeting.meeting_id}</p>
                        <p><a href="${meeting.meeting_url}" target="_blank">Open Meeting</a></p>
                    `;
                    log(`Test meeting created: ${meeting.meeting_id}`, 'info');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                info.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                log(`Meeting creation failed: ${error.message}`, 'error');
            }
        }
        
        function openMultipleWindows() {
            log('Opening multiple windows for multi-user test...', 'info');
            
            // Open 3 windows
            for (let i = 1; i <= 3; i++) {
                setTimeout(() => {
                    window.open('/', `test_window_${i}`, 'width=800,height=600');
                    log(`Opened test window ${i}`, 'info');
                }, i * 500);
            }
        }
        
        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            log('Diagnose tool loaded', 'info');
            setTimeout(testBrowserSupport, 500);
            setTimeout(testLiveKitSDK, 1000);
            showGridDemo(2);
        });
    </script>
</body>
</html> 